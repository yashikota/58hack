version: "3"

tasks:
  default:
    desc: "Display this help message"
    cmds:
      - task -l

  # Go
  lint:
    desc: "Run Go linters"
    cmds:
      - go install honnef.co/go/tools/cmd/staticcheck@latest
      - go vet ./...
      - staticcheck ./...

  test:
    desc: "Run Go tests"
    cmds:
      - go build ./...
      - go test -v ./...

  fmt:
    desc: "Format Go code"
    cmds:
      - go fmt ./...

  # Docker
  dev:
    desc: "Run development environment"
    cmds:
      - docker compose up --build

  build:
    desc: "Build Docker image"
    cmds:
      - docker build -t chronotes .

  docker-lint:
    desc: "Lint Dockerfile"
    cmds:
      - docker run --rm -i hadolint/hadolint < Dockerfile

  # API
  api-lint:
    desc: "Lint API documentation"
    cmds:
      - task: bundle
      - docker run --rm -v {{.PWD}}:/spec redocly/cli lint --config docs/api/redoc.yaml docs/api/bundled.yaml

  bundle:
    desc: "Bundle OpenAPI specification"
    cmds:
      - task: tsp
      - docker run --rm -v {{.PWD}}:/spec redocly/cli bundle docs/api/openapi.yaml -o docs/api/bundled.yaml

  docs:
    desc: "Generate API documentation"
    cmds:
      - docker run --rm -v {{.PWD}}:/spec redocly/cli build-docs docs/api/openapi.yaml --o docs/api/redoc.html

  tsp:
    desc: "Generate Open API from TypeSpec"
    cmds:
      - docker run --rm -v {{.PWD}}:/wd --workdir="/wd" -t azsdkengsys.azurecr.io/typespec compile docs/spec
